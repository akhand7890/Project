<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listing</title>
    <!-- Poppins Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <link rel="stylesheet" href="/css/listings/item.css" />
    <script>
      const mapToken = "<%= process.env.MAP_ACCESS_TOKEN %>";
      const long = "<%= item.geometry.coordinates[0] %>";
      const lat = "<%= item.geometry.coordinates[1] %>";
    </script>
  </head>

  <body>
    <!-- Header stays full width -->
    <header class="header">
      <!-- Left: Logo + Become a host -->
      <div class="header__left">
        <a class="logo" href="/listings">
          <img src="/images/logo.png" alt="homeAway logo" />
          <span class="logo-text">homeAway</span>
        </a>

        <a href="/listings/new" class="btn-host">Become a host</a>
      </div>

      <!-- Right: Auth links (use your own URLs later) -->
      <nav class="header__right">
        <% if (user) { %>
        <a href="/user/logout" class="nav-link">Log out</a>
        <% } else { %>
        <a href="/user/login" class="nav-link">Log in</a>
        <% } %>
      </nav>
    </header>

    <!-- flash Message -->
    <% if (success && success.length) { %>
    <div class="alert alert-success"><%= success[0] %></div>
    <% } %> <% if (error && error.length) { %>
    <div class="alert alert-danger"><%= error[0] %></div>
    <% } %> <% if (info && info.length) { %>
    <div class="alert alert-info"><%= info[0] %></div>
    <% } %>

    <!-- Page content container -->
    <div class="page-content">
      <div class="item-card">
        <!-- Item card content -->
        <div class="item-header">
          <h1 class="item-title"><%= item.title %></h1>
          <% if(curUser && curUser._id.equals(item.owner._id)) {%>
          <div class="item-actions">
            <a class="edit-btn" href="/listings/<%= item._id %>/edit">Edit</a>
            <form
              class="delete"
              action="/listings/<%= item._id %>/delete?_method=DELETE"
              method="POST"
            >
              <button class="delete-btn">Delete</button>
            </form>
          </div>
          <% } %>
        </div>

        <img
          class="item-image"
          src="<%= item.image.url %>"
          alt="<%= item.title %> image"
        />
        <span class="item-owner"
          ><i><b>Owner: <%= item.owner.username %></b></i></span
        >
        <span class="item-price"
          >&#8377; <%= item.price.toLocaleString("en-IN") %></span
        >
        <span class="item-location"
          ><%= item.location %>, <%= item.country %></span
        >
        <p class="item-desc"><%= item.description %></p>
        <hr class="divider" />

        <section class="reviews">
          <% if(item.reviews && item.reviews.length){ %>
          <h2 class="reviews-title">Reviews</h2>

          <!--  existing reviews list -->
          <ul class="reviews-list">
            <% item.reviews.forEach(r => { %>
            <li class="review">
              <!-- NEW wrapper row -->
              <div class="review-header">
                <div class="review-meta">
                  <span class="review-author"
                    ><%= r.author.username || "Anonymous" %></span
                  >
                  <span class="review-date"
                    ><%= new Date(r.createdAt).toLocaleDateString("en-IN")
                    %></span
                  >
                  <span class="review-stars" aria-label="<%= r.rating %> stars">
                    <%= "★".repeat(r.rating) %><span class="stars-fade"
                      ><%= "★".repeat(5 - r.rating) %></span
                    >
                  </span>
                </div>

                <%if(curUser && r.author._id.equals(curUser._id)){%>
                <form
                  action="/listings/<%= item._id %>/reviews/<%= r._id %>?_method=DELETE"
                  method="POST"
                  class="delete-review-form"
                  onsubmit="return confirm('Delete this review?');"
                >
                  <button class="delete-btn" type="submit">Delete</button>
                </form>
                <%}%>
              </div>

              <p class="review-text"><%= r.comment %></p>
            </li>
            <% }) %> <% } else if(curUser) { %>
            <p class="no-reviews">Be the first to review this listing.</p>
            <% } %>
          </ul>
          <!-- Review form -->
          <% if(curUser) { %>
          <form
            class="review-form"
            action="/listings/<%= item._id %>/reviews"
            method="POST"
          >
            <h4>Leave a review</h4>
            <div class="rating-group" role="radiogroup" aria-label="Rating">
              <!-- note: reverse order for CSS hover fill -->
              <input
                class="star-input"
                type="radio"
                id="star5"
                name="rating"
                value="5"
                required
              />
              <label class="star" for="star5" aria-label="5 stars">★</label>

              <input
                class="star-input"
                type="radio"
                id="star4"
                name="rating"
                value="4"
              />
              <label class="star" for="star4" aria-label="4 stars">★</label>

              <input
                class="star-input"
                type="radio"
                id="star3"
                name="rating"
                value="3"
              />
              <label class="star" for="star3" aria-label="3 stars">★</label>

              <input
                class="star-input"
                type="radio"
                id="star2"
                name="rating"
                value="2"
              />
              <label class="star" for="star2" aria-label="2 stars">★</label>

              <input
                class="star-input"
                type="radio"
                id="star1"
                name="rating"
                value="1"
              />
              <label class="star" for="star1" aria-label="1 star">★</label>
            </div>

            <div class="review-field">
              <label class="review-label" for="content"></label>
              <textarea
                name="content"
                id="content"
                class="review-textarea"
                placeholder="Share your experience…"
                rows="4"
                required
              ></textarea>
            </div>

            <button class="btn btn-primary" type="submit">Submit Review</button>
          </form>
          <% } %>
        </section>
        <div class="map-container">
          <h3>Where you'll be</h3>
          <div id="map"></div>
        </div>
      </div>
    </div>
    <script>
      setTimeout(() => {
        document.querySelectorAll(".alert").forEach((alert) => {
          alert.classList.add("hide");
          setTimeout(() => alert.remove(), 400); // remove after animation
        });
      }, 3000); // fades out after 3 seconds
    </script>

    <script>
      const deleteBtn = document.querySelector(".delete");
      deleteBtn.addEventListener("click", (e) => {
        const confirmDelete = confirm(
          "Do you really want to delete this listing."
        );
        if (!confirmDelete) {
          e.preventDefault();
        }
      });
    </script>
    <script src="/js/map.js"></script>
  </body>
</html>
